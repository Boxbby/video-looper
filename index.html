<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Looper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .setup-container {
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        #videoPlayer {
            width: 100%;
            max-width: 800px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button.remove {
            background-color: #dc3545;
        }
        button.remove:hover {
            background-color: #c82333;
        }
        .queue-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-loaded {
            color: #28a745;
            font-weight: bold;
        }
        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }
        input[type="number"], input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 100px;
        }
        input[type="text"] {
            width: 200px;
        }
        .preset-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .preset-item span {
            flex-grow: 1;
            margin-right: 10px;
        }
        .preset-item button {
            margin-left: 5px;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 600px) {
            body {
                margin: 10px;
            }
            .container {
                padding: 10px;
            }
            .controls {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
            input[type="number"], input[type="text"] {
                width: calc(100% - 20px);
                margin-bottom: 10px;
            }
            .preset-item {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            .preset-item button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Looper</h1>
        
        <div id="playerContainer" class="hidden">
            <video id="videoPlayer" controls>
                Your browser does not support the video element.
            </video>
            <div class="controls">
                <button id="resetLoop">Reset Loop</button>
                <button id="nextVideo">Next Video</button>
                <button id="stopPlayback">Stop</button>
            </div>
        </div>

        <div class="setup-container">
            <div class="controls">
                <input type="file" id="videoInput" accept="video/*" multiple>
                <button id="loadVideos" disabled>Load Videos</button>
                <button id="startPlayback" disabled>Start Playback</button>
            </div>
            
            <div class="controls">
                <label>End Time (seconds):
                    <input type="number" id="endTime" value="0" min="0" step="0.1">
                </label>
                <label>Repeat Count:
                    <input type="number" id="repeatCount" value="1" min="1">
                </label>
            </div>

            <h3>Video Queue</h3>
            <div id="videoQueue"></div>

            <div class="preset-section">
                <h3>Presets</h3>
                <div class="controls">
                    <input type="text" id="presetName" placeholder="Preset Name">
                    <button id="savePreset">Save Current Setup as Preset</button>
                </div>
                <div id="presetList"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...'); // Debug log
            
            const videoPlayer = document.getElementById('videoPlayer');
            const videoInput = document.getElementById('videoInput');
            const endTimeInput = document.getElementById('endTime');
            const repeatCountInput = document.getElementById('repeatCount');
            const videoQueueDiv = document.getElementById('videoQueue');
            const loadVideosBtn = document.getElementById('loadVideos');
            const startPlaybackBtn = document.getElementById('startPlayback');
            const stopPlaybackBtn = document.getElementById('stopPlayback');
            const resetLoopBtn = document.getElementById('resetLoop');
            const nextVideoBtn = document.getElementById('nextVideo');
            const playerContainer = document.getElementById('playerContainer');
            const setupContainer = document.querySelector('.setup-container');
            const presetNameInput = document.getElementById('presetName');
            const savePresetBtn = document.getElementById('savePreset');
            const presetList = document.getElementById('presetList');

            let loopInterval;
            let videoQueue = [];
            let loadedVideoQueue = [];
            let currentVideoIndex = -1;
            let repeatCounter = 0;
            let targetRepeatCount = 1;
            let globalEndTime = 0;
            let videosLoaded = false;

            // Initialize speech synthesis
            const speechSynth = window.speechSynthesis;

            function announceFileName(filename) {
                const cleanName = filename.replace(/\.[^/.]+$/, "").replace(/[_-]/g, " ");
                const utterance = new SpeechSynthesisUtterance(`Now playing: ${cleanName}`);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                speechSynth.speak(utterance);
            }

            function announceLastLoop() {
                const utterance = new SpeechSynthesisUtterance("Last loop");
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                speechSynth.speak(utterance);
            }

            function updateQueueDisplay() {
                if (!videoQueue.length) {
                    videoQueueDiv.innerHTML = '<div class="queue-item"><span>No videos in queue</span></div>';
                } else if (!videoQueueDiv.innerHTML.includes('reselect-video')) {
                    // Only update if not showing reselection UI
                    videoQueueDiv.innerHTML = '';
                    videoQueue.forEach((video, index) => {
                        const item = document.createElement('div');
                        item.className = 'queue-item';
                        const loadedStatus = videosLoaded ? 
                            '<span class="status-loaded">(Loaded)</span>' : 
                            '<span class="status-pending">(Pending Load)</span>';
                        item.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${video.name} ${loadedStatus}</span>
                                <button class="remove-video remove" data-index="${index}">Remove</button>
                            </div>
                        `;
                        if (index === currentVideoIndex) {
                            item.style.backgroundColor = '#e2e6ea';
                        }
                        videoQueueDiv.appendChild(item);
                    });

                    // Add event listeners to remove buttons
                    document.querySelectorAll('.remove-video').forEach(button => {
                        button.addEventListener('click', () => {
                            const index = parseInt(button.dataset.index);
                            removeFromQueue(index);
                        });
                    });
                }

                // Update button states
                loadVideosBtn.disabled = videoQueue.length === 0;
                startPlaybackBtn.disabled = !videosLoaded;
            }

            function removeFromQueue(index) {
                videoQueue.splice(index, 1);
                if (index < currentVideoIndex) {
                    currentVideoIndex--;
                }
                videosLoaded = false;
                loadedVideoQueue = [];
                updateQueueDisplay();
            }

            function loadVideos() {
                loadedVideoQueue = videoQueue.map(file => ({
                    file: file,
                    url: URL.createObjectURL(file)
                }));
                videosLoaded = true;
                updateQueueDisplay();
            }

            function playNextVideo() {
                if (currentVideoIndex < loadedVideoQueue.length - 1) {
                    currentVideoIndex++;
                    const video = loadedVideoQueue[currentVideoIndex];
                    videoPlayer.src = video.url;
                    videoPlayer.load();
                    videoPlayer.play();
                    updateQueueDisplay();
                    announceFileName(video.file.name);
                    return true;
                }
                return false;
            }

            function startPlayback() {
                if (!videosLoaded) {
                    alert('Please load the videos first');
                    return;
                }

                if (loadedVideoQueue.length === 0) {
                    alert('Please select at least one video');
                    return;
                }

                globalEndTime = parseFloat(endTimeInput.value);
                targetRepeatCount = parseInt(repeatCountInput.value) || 1;

                if (isNaN(globalEndTime) || globalEndTime <= 0) {
                    alert('Please enter a valid end time');
                    return;
                }

                setupContainer.classList.add('hidden');
                playerContainer.classList.remove('hidden');
                
                currentVideoIndex = -1;
                playNextVideo();
                startLooping();
            }

            function startLooping() {
                if (loopInterval) {
                    clearInterval(loopInterval);
                }

                repeatCounter = 0;
                loopInterval = setInterval(() => {
                    if (videoPlayer.currentTime >= Math.min(globalEndTime, videoPlayer.duration)) {
                        repeatCounter++;
                        if (repeatCounter >= targetRepeatCount) {
                            if (!playNextVideo()) {
                                clearInterval(loopInterval);
                                videoPlayer.pause();
                            } else {
                                repeatCounter = 0;
                            }
                        } else {
                            videoPlayer.currentTime = 0;
                            // Announce last loop when starting the final repeat
                            if (repeatCounter === targetRepeatCount - 1) {
                                announceLastLoop();
                            }
                        }
                    }
                }, 50);
            }

            function stopPlayback() {
                if (loopInterval) {
                    clearInterval(loopInterval);
                    loopInterval = null;
                }
                videoPlayer.pause();
                playerContainer.classList.add('hidden');
                setupContainer.classList.remove('hidden');
                currentVideoIndex = -1;
                updateQueueDisplay();
            }

            function loadPreset(preset) {
                console.log('Loading preset values:', preset);
                
                // Set the input values
                endTimeInput.value = preset.endTime || 0;
                repeatCountInput.value = preset.repeatCount || 1;
                
                // Clear existing queue
                videoQueue = [];
                loadedVideoQueue = [];
                videosLoaded = false;
                
                // Update the UI
                videoQueueDiv.innerHTML = '';
                preset.videos.forEach((video, index) => {
                    const item = document.createElement('div');
                    item.className = 'queue-item';
                    
                    // Create a unique file input for this video
                    const fileInputId = `reselect-video-${index}`;
                    item.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${video.name}</span>
                            <label class="button" style="cursor: pointer; padding: 2px 8px; background: #007bff; color: white; border-radius: 4px;">
                                Reselect
                                <input type="file" 
                                    id="${fileInputId}" 
                                    accept="video/*" 
                                    style="display: none;"
                                    data-original-name="${video.name}"
                                >
                            </label>
                            <span class="status-pending">(Pending)</span>
                        </div>
                    `;
                    videoQueueDiv.appendChild(item);
                    
                    // Add event listener for this specific file input
                    const fileInput = document.getElementById(fileInputId);
                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            // Replace in the queue at the correct position
                            while (videoQueue.length <= index) {
                                videoQueue.push(null);
                            }
                            videoQueue[index] = file;
                            
                            // Update status
                            const statusSpan = item.querySelector('.status-pending');
                            statusSpan.textContent = '(Selected)';
                            statusSpan.className = 'status-loaded';
                            
                            // Clean up null entries and update display
                            videoQueue = videoQueue.filter(f => f !== null);
                            videosLoaded = false;
                            loadedVideoQueue = [];
                            updateQueueDisplay();
                        }
                    });
                });
                
                updateQueueDisplay();
            }

            function updatePresetList() {
                const presets = JSON.parse(localStorage.getItem('videoLooperPresets') || '[]');
                console.log('Current presets:', presets); // Debug log
                presetList.innerHTML = '';
                presets.forEach((preset, index) => {
                    const item = document.createElement('div');
                    item.className = 'preset-item';
                    item.innerHTML = `
                        <span>${preset.name} (${preset.videos.length} videos, ${preset.repeatCount} loops)</span>
                        <button class="load-preset" data-index="${index}">Load</button>
                        <button class="delete-preset remove" data-index="${index}">Delete</button>
                    `;
                    presetList.appendChild(item);
                });

                // Add event listeners to the newly created buttons
                document.querySelectorAll('.load-preset').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        console.log('Loading preset at index:', index); // Debug log
                        const presets = JSON.parse(localStorage.getItem('videoLooperPresets') || '[]');
                        if (presets[index]) {
                            console.log('Loading preset:', presets[index]); // Debug log
                            loadPreset(presets[index]);
                        }
                    });
                });

                document.querySelectorAll('.delete-preset').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        console.log('Deleting preset at index:', index); // Debug log
                        let presets = JSON.parse(localStorage.getItem('videoLooperPresets') || '[]');
                        presets.splice(index, 1);
                        localStorage.setItem('videoLooperPresets', JSON.stringify(presets));
                        updatePresetList();
                    });
                });
            }

            savePresetBtn.addEventListener('click', () => {
                const name = presetNameInput.value.trim();
                if (!name) {
                    alert('Please enter a preset name');
                    return;
                }

                const preset = {
                    name: name,
                    endTime: parseFloat(endTimeInput.value) || 0,
                    repeatCount: parseInt(repeatCountInput.value) || 1,
                    videos: videoQueue.map(file => ({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        lastModified: file.lastModified
                    }))
                };

                console.log('Saving preset:', preset); // Debug log

                let presets = JSON.parse(localStorage.getItem('videoLooperPresets') || '[]');
                
                // Check for duplicate names
                const existingIndex = presets.findIndex(p => p.name === name);
                if (existingIndex >= 0) {
                    if (confirm('A preset with this name already exists. Do you want to update it?')) {
                        presets[existingIndex] = preset;
                    } else {
                        return;
                    }
                } else {
                    presets.push(preset);
                }
                
                localStorage.setItem('videoLooperPresets', JSON.stringify(presets));
                console.log('Saved presets:', presets); // Debug log
                presetNameInput.value = '';
                updatePresetList();
                alert('Preset saved successfully!'); // User feedback
            });

            // Add debug information display
            const debugDiv = document.createElement('div');
            debugDiv.style.marginTop = '20px';
            debugDiv.style.padding = '10px';
            debugDiv.style.border = '1px solid #ccc';
            debugDiv.style.display = 'none'; // Hidden by default
            
            const toggleDebug = document.createElement('button');
            toggleDebug.textContent = 'Toggle Debug Info';
            toggleDebug.addEventListener('click', () => {
                debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
                updateDebugInfo();
            });
            
            function updateDebugInfo() {
                if (debugDiv.style.display === 'block') {
                    const presets = JSON.parse(localStorage.getItem('videoLooperPresets') || '[]');
                    debugDiv.innerHTML = `
                        <h3>Debug Information</h3>
                        <pre>
Current Queue: ${videoQueue.length} videos
Loaded Queue: ${loadedVideoQueue.length} videos
Videos Loaded: ${videosLoaded}
Current Index: ${currentVideoIndex}
Repeat Counter: ${repeatCounter}
Target Repeats: ${targetRepeatCount}
Global End Time: ${globalEndTime}
Saved Presets: ${JSON.stringify(presets, null, 2)}
                        </pre>
                    `;
                }
            }
            
            // Add debug elements to the page
            document.querySelector('.container').appendChild(toggleDebug);
            document.querySelector('.container').appendChild(debugDiv);
            
            // Update debug info periodically
            setInterval(updateDebugInfo, 1000);

            // Initialize preset list and button states when the page loads
            updatePresetList();
            updateQueueDisplay();
            
            // Event Listeners
            videoInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                videoQueue = files;
                videosLoaded = false;
                loadedVideoQueue = [];
                updateQueueDisplay();
            });

            loadVideosBtn.addEventListener('click', loadVideos);
            startPlaybackBtn.addEventListener('click', startPlayback);
            stopPlaybackBtn.addEventListener('click', stopPlayback);
            resetLoopBtn.addEventListener('click', () => {
                if (loopInterval) {
                    clearInterval(loopInterval);
                    loopInterval = null;
                }
                videoPlayer.currentTime = 0;
                repeatCounter = 0;
                startLooping();
            });

            nextVideoBtn.addEventListener('click', () => {
                if (loopInterval) {
                    clearInterval(loopInterval);
                    loopInterval = null;
                }
                if (playNextVideo()) {
                    startLooping();
                }
            });
        });
    </script>
</body>
</html>
